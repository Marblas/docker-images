name: Docker Image CI

on:
  push:
  schedule:
  - cron: '*/5 * * * *'

jobs:
  build:
    strategy:
      matrix:
        image:
          - "mixpanel-proxy"
          - "alpine-curl"
          - "civicrm-php"
          - "civicrm-sshd"
          - "debian-shell"
          - "metabase-watchdog"
          - "mycli"
          - "nodejs-ftp-srv"
          - "terraform-tfnotify"
          - "travis-cli"
          - "ubuntu-sshd-github"
          - "zabbix-agent"

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Build image - ${{ matrix.image }}
      run: docker build ${{ matrix.image }} --tag docker-registry.siecobywatelska.pl/${{ matrix.image }}:latest
    - name: "Skip push on non-master branch"
      uses: "actions/bin/filter@master"
      with:
        args: "branch master"
    - name: "Docker login"
      env:
        DOCKER_REGISTRY_URL: docker-registry.siecobywatelska.pl
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: echo "${DOCKER_PASSWORD}" | docker login -u ${DOCKER_USERNAME} --password-stdin ${DOCKER_REGISTRY_URL}
    - name: Push image - ${{ matrix.image }}
      run: docker push docker-registry.siecobywatelska.pl/${{ matrix.image }}:latest